---
- name: load variables
  tags: [common, secrets]
  include_vars: '{{ playbook_dir }}/secrets.env.yaml'

- name: check ij cert manager exists
  shell:
    cmd: kubectl get service --all-namespaces
  register: kubectl_namespaces

# - name: Print kubectl get service --all-namespaces
#   debug:
#     var: kubectl_namespaces.stdout

- name: install cert manager
  shell:
    cmd: kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.3.1/cert-manager.yaml
  delegate_to: 127.0.0.1
  register: kubectl_cert
  when: kubectl_namespaces.stdout.find('cert-manager') == -1

# - name: Print kubectl apply output
#   debug:
#     var: kubectl_cert.stdout

# TODO:
# Set Up Authentication with Traefik and k3s
# https://k3s.rocks/https-cert-manager-letsencrypt/

- name: install cert manager
  shell:
    cmd: kubectl apply -f https://github.com/jetstack/cert-manager/releases/download/v1.3.1/cert-manager.yaml
  delegate_to: 127.0.0.1
  register: kubectl_cert
  when: kubectl_namespaces.stdout.find('cert-manager') == -1

- name: expose traefik
  shell:
    cmd: kubectl apply -f files/lets-encrypt.yaml
    chdir: /mnt/f/_code/sheol-playbook/roles/base/cert-manager
  delegate_to: 127.0.0.1
  register: kubectl_traefik

# - name: Print kubectl apply output
#   debug:
#     var: kubectl_cert.stdout
