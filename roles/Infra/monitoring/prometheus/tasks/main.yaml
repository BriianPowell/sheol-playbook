---
- name: load variables
  tags: [common, secrets]
  include_vars: '{{ playbook_dir }}/secrets.env.yaml'

- name: create monitoring namespace
  shell:
    cmd: kubectl create namespace monitoring
  delegate_to: 127.0.0.1
  register: kubectl_grafana_namespace

- name: Apply Prometheus Cluster Role
  shell:
    cmd: kubectl apply -f files/prometheus-cluster-role.yaml
    chdir: '{{ playbook_dir }}/roles/infra/monitoring/prometheus'
  delegate_to: 127.0.0.1
  register: kubectl_prometheus_cluster_role

- name: Apply Prometheus Cluster Role
  shell:
    cmd: kubectl apply -f files/prometheus-config.yaml
    chdir: '{{ playbook_dir }}/roles/infra/monitoring/prometheus'
  delegate_to: 127.0.0.1
  register: kubectl_prometheus_config

- name: Apply Prometheus Deployment
  shell:
    cmd: kubectl apply -f files/prometheus.yaml
    chdir: '{{ playbook_dir }}/roles/infra/monitoring/prometheus'
  delegate_to: 127.0.0.1
  register: kubectl_prometheus

- name: Apply Prometheus Ingress
  shell:
    cmd: kubectl apply -f files/prometheus-ingress.yaml
    chdir: '{{ playbook_dir }}/roles/infra/monitoring/prometheus'
  delegate_to: 127.0.0.1
  register: kubectl_prometheus_ingress
